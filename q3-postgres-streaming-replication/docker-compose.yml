version: "3.9"

services:
  postgres-primary:
    image: postgres:16
    container_name: postgres-primary
    environment:
      POSTGRES_USER: app_user
      POSTGRES_PASSWORD: app_password
      POSTGRES_DB: app_db
      PGDATA: /var/lib/postgresql/data
    ports:
      - "5432:5432"
    volumes:
      - primary_data:/var/lib/postgresql/data
      - ./primary/init-primary.sql:/docker-entrypoint-initdb.d/init-primary.sql:ro
      - ./primary/init-replication.sh:/docker-entrypoint-initdb.d/init-replication.sh:ro
    command: >
      postgres
      -c wal_level=replica
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c listen_addresses='*'

  postgres-replica:
    image: postgres:16
    container_name: postgres-replica
    environment:
      POSTGRES_USER: app_user
      POSTGRES_PASSWORD: app_password
      PGDATA: /var/lib/postgresql/data
    depends_on:
      - postgres-primary
    ports:
      - "5433:5432"
    volumes:
      - replica_data:/var/lib/postgresql/data
      - ./replica/init-replica.sh:/docker-entrypoint-initdb.d/init-replica.sh:ro

volumes:
  primary_data:
  replica_data:
